<h1 id="diagnose-problems">Diagnose Problems</h1>

<hr />

<p>If something should ever go wrong with an application, what should you do about getting diagnostics?</p>

<p>Let’s look at the Getting Started application, and use that to explain how to get diagnostics out of the Framework.</p>

<p>Key Point: This is a framework - so your application will need to have it’s own logging framework. Plus, your application could also have configuration information to control ‘s own logging. Composer does use the Winston logging module by default - and will use the Config module to look for any configuration information. If none is found, then a set of defaults will be used.</p>

<p>Note that the config module does write out a warning, if there are no configuration files set. Eg. <code class="highlighter-rouge">WARNING: No configurations found in configuration directory</code>. This can be suppressed with an environment variable if you are happy with the defaults and don’t wish to use config in your application. See more information <a href="https://github.com/lorenwest/node-config/wiki/Environment-Variables#suppress_no_config_warning">here</a>.</p>

<p>There are two containers that are relevant to logging;</p>

<ul>
  <li>the one the application is running in, and</li>
  <li>the chain code container that executes the transaction functions.</li>
</ul>

<h2 id="application">Application</h2>

<p>Internally,  uses the <a href="https://github.com/winstonjs/winston">Winston</a> node.js logging package by default, with an initial level of log points and destinations set up.</p>

<h2 id="default-configuration">Default Configuration</h2>

<p>The framework will log information at these levels.</p>

<ul>
  <li>Error</li>
  <li>Warn</li>
  <li>Info</li>
  <li>Verbose</li>
  <li>Debug</li>
</ul>

<p>The ‘Silly’ level doesn’t get used.</p>

<h2 id="locations-of-information">Locations of information</h2>

<p>By default, there are two locations for data:</p>

<ul>
  <li>
    <p>One is a text file that is the location <code class="highlighter-rouge">${CurrentWorkingDir}/logs/trace_&lt;processid&gt;.trc</code></p>
  </li>
  <li>
    <p>The other is <code class="highlighter-rouge">stdout</code>. By default, <code class="highlighter-rouge">stdout</code> will only show any data logged with a level of ‘error’ and the file will show any data logged with ‘info’ or above (i.e. info, warn and error).</p>
    <h2 id="control-of-what-is-produced">Control of what is produced</h2>
    <p>The Config module is used to locate information to control how the logs are produced.</p>
  </li>
</ul>

<p>For example</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"gettingstarted"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nt">"participantId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"WebAppAdmin"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"participantPwd"</span><span class="w"> </span><span class="p">:</span><span class="s2">"DJY27pEnl16d"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"businessNetworkIdentifier"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"digitalproperty-network"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"connectionProfile"</span><span class="w"> </span><span class="p">:</span><span class="s2">"defaultProfile"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"ComposerConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nt">"debug"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nt">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
         </span><span class="nt">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
           </span><span class="nt">"console"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
             </span><span class="nt">"enabledLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="p">,</span><span class="w">
             </span><span class="nt">"alwaysLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"none"</span><span class="w">

           </span><span class="p">},</span><span class="w">
           </span><span class="nt">"file"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
             </span><span class="nt">"filename"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./trace_PID.log"</span><span class="p">,</span><span class="w">
             </span><span class="nt">"enabledLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"silly"</span><span class="p">,</span><span class="w">
             </span><span class="nt">"alwaysLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="w">
           </span><span class="p">}</span><span class="w">
         </span><span class="p">}</span><span class="w">
       </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>The first section is specific to the Getting Started application, the second <code class="highlighter-rouge">ComposerConfig</code> section is for the .</p>

<ul>
  <li><code class="highlighter-rouge">logger</code> is used to refer the module that does actual logging. default is implying that this is the winston framework</li>
  <li><code class="highlighter-rouge">config</code> is passed to the logger to control what it does.  So this section is specific to the logger in use.</li>
</ul>

<p>##Enabling more information</p>

<p>The standard way of enabling node.js applications for debug is to use the <code class="highlighter-rouge">DEBUG</code> environment variable. So therefore</p>

<div class="highlighter-rouge"><pre class="highlight"><code>DEBUG=composer:* node myApplication.js
</code></pre>
</div>

<p>Will enabled more tracing - this then will use the levels marked as <code class="highlighter-rouge">enabledLevel</code> in the configuration above.</p>

<h1 id="how-to-find-out-which-chaincode-container-has-the-deployed-network">How to find out which chaincode container has the deployed network?</h1>

<p>Each Business Network is deployed to it’s own Chaincode container.  In the case of errors say with a transaction function, it can be helpful to look at the logs from that container and see what has happened. <code class="highlighter-rouge">docker logs &lt;containerid&gt;</code> will show the logs but you need to know the container id.</p>

<p>Firstly list the docker processes and look for the image name; this command will do this for you in one step</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">matthew@matthew-VirtualBox:~$ </span>docker ps | cut -b 1-13,21-93
CONTAINER ID IMAGE                                                                    
f71e2a630d6a dev-vp0-9d0a2be10fc5b815bbca1f81c9abcb7072e33fc760342c5789c5bf9703c429c7
bb5db2ca4e6a hyperledger/fabric-peer                                                  
3ec0e41c4898 hyperledger/fabric-membersrvc     
</code></pre>
</div>

<p>The hex value after the dev-vp0 is the ‘chaincodeid’. If you look in the connection profiles directory you’ll see a simple JSON file that has the anem of the network mapped to the chaincode id. In this example we have two neworks listed.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">matthew@matthew-VirtualBox:~$ </span>cat ~/.composer-connection-profiles/defaultProfile/connection.json
<span class="o">{</span>
    <span class="s2">"type"</span>: <span class="s2">"hlf"</span>,
    <span class="s2">"membershipServicesURL"</span>: <span class="s2">"grpc://localhost:7054"</span>,
    <span class="s2">"peerURL"</span>: <span class="s2">"grpc://localhost:7051"</span>,
    <span class="s2">"eventHubURL"</span>: <span class="s2">"grpc://localhost:7053"</span>,
    <span class="s2">"keyValStore"</span>: <span class="s2">"/home/matthew/.composer-credentials"</span>,
    <span class="s2">"deployWaitTime"</span>: <span class="s2">"300"</span>,
    <span class="s2">"invokeWaitTime"</span>: <span class="s2">"100"</span>,
    <span class="s2">"networks"</span>: <span class="o">{</span>
        <span class="s2">"digitalproperty-network"</span>: <span class="s2">"e3ec656109284b63d5b7b1925454c9904e6c9c82b2053ed190d2f199e0fb0dad"</span>,
        <span class="s2">"carauction-network"</span>: <span class="s2">"9d0a2be10fc5b815bbca1f81c9abcb7072e33fc760342c5789c5bf9703c429c7"</span>
    <span class="o">}</span>
<span class="o">}</span>;
</code></pre>
</div>
<p>By inspection, the ids match for the carauction-network therefore we know now which chaincode container is which.</p>
