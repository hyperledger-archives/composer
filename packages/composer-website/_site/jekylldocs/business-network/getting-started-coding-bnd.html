<h1 id="coding-a-business-network-definition">Coding a Business Network Definition</h1>

<hr />

<p>This tutorial will take you through how to code and deploy a Business Network Definition. How to put together the files, and code artifacts needed and what to do with them.
This is after the important step of modeling the actual business network and the entities within it.  For this tutorial we are going to continue to use the Digital Property Network but from the position of having only the model file and the transction function file.</p>

<h1 id="style-of-creation">Style of creation</h1>
<p>The final form of the Business Network Archive is mandatory for . This file is created using the <code class="highlighter-rouge">composer archive create</code> command; however how the files that are taken as input to that command are created and managed is not mandatory. In all the documents and websites we are showing a selection of approaches we consider to be good practice.</p>

<p>For this tutorial, a single NPM module will be created for both the model and transaction functions. An archive will be created from this locally and deployed.
In production this NPM module would be published to a NPM repository, in development/test context this is not required.</p>

<p>Also the command line set of tools will be used.</p>

<p>#Creating the npm Module.</p>

<h2 id="basic-infrastrure">Basic Infrastrure</h2>
<p>We will need to have the command line  tools installed. If you’ve not done this yet</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>npm install -g composer-cli
</code></pre>
</div>

<p>Ensure that you have a new clean working directory</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mkdir property-network <span class="o">&amp;&amp;</span> <span class="nb">cd </span>property-network <span class="o">&amp;&amp;</span> <span class="nb">pwd</span>
/home/matthew/property-network
</code></pre>
</div>

<p>Now we need to setup the NPM module as follows. It’s ok to accept the default values, but you are welcome to change any that you wish.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>npm init
This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See <span class="sb">`</span>npm <span class="nb">help </span>json<span class="sb">`</span> <span class="k">for </span>definitive documentation on these fields
and exactly what they <span class="k">do</span>.

Use <span class="sb">`</span>npm install &lt;pkg&gt; --save<span class="sb">`</span> afterwards to install a package and
save it as a dependency <span class="k">in </span>the package.json file.

Press ^C at any <span class="nb">time </span>to quit.
name: <span class="o">(</span>property-network<span class="o">)</span>
version: <span class="o">(</span>1.0.0<span class="o">)</span>
description:
entry point: <span class="o">(</span>index.js<span class="o">)</span>
<span class="nb">test command</span>:
git repository:
keywords:
author:
license: <span class="o">(</span>ISC<span class="o">)</span>
About to write to /home/matthew/property-network/package.json:

<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"property-network"</span>,
  <span class="s2">"version"</span>: <span class="s2">"1.0.0"</span>,
  <span class="s2">"description"</span>: <span class="s2">""</span>,
  <span class="s2">"main"</span>: <span class="s2">"index.js"</span>,
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"test"</span>: <span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span>
  <span class="o">}</span>,
  <span class="s2">"author"</span>: <span class="s2">""</span>,
  <span class="s2">"license"</span>: <span class="s2">"ISC"</span>
<span class="o">}</span>


Is this ok? <span class="o">(</span>yes<span class="o">)</span> yes
</code></pre>
</div>

<p>The infrastructure is now in place, the model and transaction functions can now be added.</p>

<h2 id="model-file">Model file</h2>

<p>The files are simple text files following a defined syntax, create a new blank file.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>touch models/DigitalLandTitle.cto
</code></pre>
</div>

<p>Load that file up in any editor and then add your own model, or copy in the code below that is the DigitalLandTitle Getting Started Example</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/**  A 'Getting Started Tutorial' to work with Hyperledger Composer
*/

namespace net.biz.digitalPropertyNetwork

asset LandTitle identified by titleId {
  o String   titleId
  --&gt; Person   owner
  o String   information
  o Boolean  forSale   optional
}

asset SalesAgreement identified by salesId {
  o String    salesId
  --&gt; Person    buyer
  --&gt; Person    seller
  --&gt; LandTitle title
}

participant Person identified by personId {
  o String personId
  o String firstName
  o String lastName
}

transaction RegisterPropertyForSale identified by transactionId{
  o String transactionId
  --&gt; Person seller
  --&gt; LandTitle title
}
</code></pre>
</div>

<h2 id="transaction-functions">Transaction functions</h2>
<p>The transaction function files are stadard JavaScript files. Create a blank file for this.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>touch lib/DigitalLandTitle.js
</code></pre>
</div>

<p>In this example the following is the implementation of the <code class="highlighter-rouge">registeryPropertyForSale</code> transaction. Copy this in to the <code class="highlighter-rouge">lib/DigitalLandTitle.js</code> file.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s1">'use strict'</span><span class="p">;</span>

<span class="cm">/**
 * Process a property that is held for sale
 * @param {net.biz.digitalPropertyNetwork.RegisterPropertyForSale} propertyForSale the property to be sold
 * @transaction
 */</span>
<span class="kd">function</span> <span class="nx">onRegisterPropertyForSale</span><span class="p">(</span><span class="nx">propertyForSale</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'### onRegisterPropertyForSale '</span> <span class="o">+</span> <span class="nx">propertyForSale</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="nx">propertyForSale</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">forSale</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">returAssetRegistry</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork.LandTitle'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">propertyForSale</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>That has completed the creation of the npm module for the Business Network, the next step is to form this into a Business Network Archive</em></p>

<h1 id="creating-the-business-network-archive">Creating the Business Network Archive</h1>
<p>Once we have the network complete we can create a business network definition archive. This is the unit will actually be deployable to the HyperLedger Fabric.</p>

<p>There is a <code class="highlighter-rouge">composer archive</code> command that can be used to create and inspect these archives. The <code class="highlighter-rouge">composer network</code> command is then used to administer the business network archive on the Hyperledger Fabric.</p>

<h3 id="creating-an-archive">Creating an archive</h3>

<p>The <code class="highlighter-rouge">composer archive create</code> command is used to create the archive. The <code class="highlighter-rouge">--archiveFile</code> option is used to specify the name of the archive file to create. If this is not specified then a default name will be used that is based on the identifier of the business network (sanitized to be suitable as a filename). For example <code class="highlighter-rouge">digitalPropertyNetwork-0.1.2.bna</code>.</p>

<p>There are two options that control where the inputs for the archive create from.</p>

<ul>
  <li><em>–sourceType</em> can either be <em>dir</em> or <em>module</em>.  <em>dir</em> implies that the source is from a directory, <em>module</em> from an NPM module that has been installed.</li>
  <li><em>–sourceName</em> is either the directory name or the NPM module name as appropriate.</li>
</ul>

<p>In the case of a directory being given, this directory must containsthe <code class="highlighter-rouge">package.json</code> file of the Business Network’s npm module’s package.json.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>composer archive create --archiveFile digitalLandTitle.bna --sourceType dir --sourceName .
</code></pre>
</div>

<p>Once you have this archive it can then be deployed to Hyperledger (which will assuming is all running for the moment)</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>composer network deploy --archiveFile  DigitalLandTitle.bna  --enrollId WebAppAdmin --enrollSecret DJY27pEnl16d
</code></pre>
</div>

<h2 id="continued-development-of-the-model-or-transaction-functions">Continued Development of the model or transaction functions</h2>

<p>The next step in the development process would be to update either the model or transaction functions or both. When you’ve done this, the steps are to recreate the archive and then redeploy the network.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>composer archive create --archiveFile digitalLandTitle.bna ---sourceType dir --sourceName .
<span class="gp">$ </span>composer network update --archiveFile digitalproperty-network@0.0.1.bna  --enrollId WebAppAdmin --enrollSecret DJY27pEnl16d
</code></pre>
</div>

<p>#Complete!</p>

<p>This tutorial is now complete. The next step would be to create a REST api for applications to use. The <a href="../applications/genapp.html">next step</a> will create a REST api for the Digital Property Network.</p>
