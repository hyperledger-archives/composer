<p>#Adding a REST API to the business network</p>

<p>This guide will show how to generate a REST api for the Digital Property business network. This api will be dynamically generated by using <a href="https://loopback.io/doc/index.html">LoopBack</a> from the specified Business Network Model. What is generated is not a generic api, but is specifically configured to let you interact with the assets you have specified.</p>

<p>To get started with using this to create a REST interface to a Business Network, follow the steps below.  If you’ve not followed the <a href="./getting-started.md">Getting Started</a> guide yet, it’s worth following that first so you have Fabric Composer up and running on Hyperledger.</p>

<h1 id="check-that-the-digital-land-title-network-is-up-and-running">Check that the Digital Land Title Network is up and running</h1>

<p>Let’s check the assets that are in the Digital Land Title registries. From your existing getting started directory issue</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>npm run listAssets

<span class="gp">&gt; </span>concerto-gettingstarted@1.0.0 listAssets /home/matthew/git17/Concerto-GettingStarted
<span class="gp">&gt; </span>node cli.js landregistry list

info: <span class="o">[</span>Handel] IBM Concerto: Handel appliation
info: <span class="o">[</span>Handel] LandRegistry:&lt;init&gt; businessNetworkDefinition obtained digitalproperty-network@0.0.22-20170116133558
info: <span class="o">[</span>Handel] listTitles Getting the asset registry
info: <span class="o">[</span>Handel] listTitles Getting all assest from the registry.
info: <span class="o">[</span>Handel] listTitles Current Land Titles
info: <span class="o">[</span>Handel] Titles listed
info: <span class="o">[</span>Handel]
┌──────────┬────────────────┬────────────┬─────────┬─────────────────────────────┬─────────┐
│ TitleID  │ OwnerID        │ First Name │ Surname │ Description                 │ ForSale │
├──────────┼────────────────┼────────────┼─────────┼─────────────────────────────┼─────────┤
│ LID:1148 │ PID:1234567890 │ Fred       │ Bloggs  │ A nice house <span class="k">in </span>the country │ Yes     │
├──────────┼────────────────┼────────────┼─────────┼─────────────────────────────┼─────────┤
│ LID:6789 │ PID:1234567890 │ Fred       │ Bloggs  │ A small flat <span class="k">in </span>the city    │ No      │
└──────────┴────────────────┴────────────┴─────────┴─────────────────────────────┴─────────┘
info: <span class="o">[</span>Handel] Command completed successfully.

</code></pre>
</div>

<p>We can see the two sample land titles listed.</p>

<h2 id="install-loopback">Install LoopBack</h2>

<p>We need to install LoopBack; this is two npm modules <code class="highlighter-rouge">loopback</code> and <code class="highlighter-rouge">loopback-cli</code>.</p>

<blockquote>
  <p>You might need to issue both of these using sudo.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install -g loopback
npm install -g loopback-cli
</code></pre>
</div>

<h2 id="creating-the-loopback-server-application">Creating the LoopBack server application</h2>

<p>We need to have a LoopBack server running to serve the REST api. As this is an application itself, it’s worth creating a new directory for this.  So assuming you’re still in the Getting Started directory create a new directory as follows.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">cd</span> ..
mkdir loopback-server
<span class="nb">cd </span>loopback-server
</code></pre>
</div>

<p>You can now create the loop back server. Issue the command <code class="highlighter-rouge">lb</code> in this new directory. This is the output you’ll see together with the answers to the questions you’ll be asked.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>lb

     _-----_
    |       |    ╭──────────────────────────╮
    |--<span class="o">(</span>o<span class="o">)</span>--|    │  Let<span class="s1">'s create a LoopBack │
   `---------´   │       application!       │
    ( _´U`_ )    ╰──────────────────────────╯
    /___A___\   /
     |  ~  |
   __'</span>.___.<span class="s1">'__
 ´   `  |° ´ Y `

? What'</span>s the name of your application? rest
? Which version of LoopBack would you like to use? 2.x <span class="o">(</span>long term support<span class="o">)</span>
? What kind of application <span class="k">do </span>you have <span class="k">in </span>mind? api-server <span class="o">(</span>A LoopBack API server with <span class="nb">local </span>User auth<span class="o">)</span>
Generating .yo-rc.json


I<span class="s1">'m all done. Running npm install for you to install the required dependencies. If this fails, try running the command yourself.


   create .editorconfig
   create .eslintignore
   create .eslintrc
   create server/boot/root.js
   create server/middleware.development.json
   create server/middleware.json
   create server/server.js
   create README.md
   create server/boot/authentication.js
   create .gitignore
   create client/README.md

</span></code></pre>
</div>

<p>That is now all created - the next step is to add an adapter to link with the Fabric Composer runtime.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install --save loopback-connector-composer
</code></pre>
</div>

<p>Last step before trying things out is to add a function in the <code class="highlighter-rouge">server/boot</code> boot directory. This function is below - the key parts are in the <code class="highlighter-rouge">datasource</code> variable.  These have been filled out with the same settings of the Getting Started guide.
Create a new file in this directory with the following contents, the name of the file is not important, so for example <code class="highlighter-rouge">loopback-composer.js</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
<span class="s1">'use strict'</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>

  <span class="kr">const</span> <span class="nx">dataSource</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">loopback</span><span class="p">.</span><span class="nx">createDataSource</span><span class="p">(</span><span class="s1">'Concerto'</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Concerto"</span><span class="p">,</span>
    <span class="s2">"connector"</span><span class="p">:</span> <span class="s2">"loopback-connector-composer"</span><span class="p">,</span>
    <span class="s2">"connectionProfileName"</span> <span class="p">:</span> <span class="s1">'defaultProfile'</span><span class="p">,</span>
    <span class="s2">"businessNetworkIdentifier"</span> <span class="p">:</span> <span class="s1">'digitalproperty-network'</span><span class="p">,</span>
    <span class="s2">"participantId"</span> <span class="p">:</span> <span class="s1">'WebAppAdmin'</span><span class="p">,</span>
    <span class="s2">"participantPwd"</span> <span class="p">:</span> <span class="s1">'DJY27pEnl16d'</span>
  <span class="p">});</span>

  <span class="nx">dataSource</span><span class="p">.</span><span class="nx">discoverModelDefinitions</span><span class="p">({},</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">modelDefinitions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Concerto Loopback Connector'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">modelDefinitions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">modelDefinition</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'found modelDefinition = '</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">modelDefinition</span><span class="p">))</span>
      <span class="nx">dataSource</span><span class="p">.</span><span class="nx">discoverSchemas</span><span class="p">(</span><span class="nx">modelDefinition</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span><span class="na">visited</span><span class="p">:</span> <span class="p">{},</span> <span class="na">associations</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">modelSchema</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// this is required because LoopBack doesn't like dots in model schema names</span>
        <span class="nx">modelSchema</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">modelSchema</span><span class="p">.</span><span class="nx">plural</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\.</span><span class="sr">/g</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">);</span>
        <span class="nx">modelSchema</span><span class="p">.</span><span class="nx">idInjection</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">loopback</span><span class="p">.</span><span class="nx">createModel</span><span class="p">(</span><span class="nx">modelSchema</span><span class="p">);</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">dataSource</span><span class="p">:</span> <span class="nx">dataSource</span><span class="p">,</span>
          <span class="na">public</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre>
</div>

<h2 id="run-loopback-server">Run LoopBack server</h2>

<p>Go back to the <code class="highlighter-rouge">loopback-server</code> directory and start the server as follows.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nv">$cd</span> ../..
<span class="gp">$ </span>node .
WARNING: No configurations found <span class="k">in </span>configuration directory:/home/matthew/git17/rest/config
WARNING: To disable this warning <span class="nb">set </span>SUPPRESS_NO_CONFIG_WARNING <span class="k">in </span>the environment.
Web server listening at: http://0.0.0.0:3000
Browse your REST API at http://0.0.0.0:3000/explorer
Concerto Loopback Connector
found modelDefinition <span class="o">=</span> <span class="o">{</span><span class="s2">"type"</span>:<span class="s2">"table"</span>,<span class="s2">"name"</span>:<span class="s2">"net.biz.digitalPropertyNetwork.LandTitle"</span><span class="o">}</span>
found modelDefinition <span class="o">=</span> <span class="o">{</span><span class="s2">"type"</span>:<span class="s2">"table"</span>,<span class="s2">"name"</span>:<span class="s2">"net.biz.digitalPropertyNetwork.SalesAgreement"</span><span class="o">}</span>
found modelDefinition <span class="o">=</span> <span class="o">{</span><span class="s2">"type"</span>:<span class="s2">"table"</span>,<span class="s2">"name"</span>:<span class="s2">"net.biz.digitalPropertyNetwork.Person"</span><span class="o">}</span>

</code></pre>
</div>

<h2 id="looking-at-the-generated-apis">Looking at the generated APIs</h2>

<p>Launch your browser and go to the URL given (http://0.0.0.0:3000/explorer).  You’ll see a screen similar to this.</p>

<p><img src="../images/loopback-1.png" alt="LoopBack-1" /></p>

<p>Select the Land Title asset, and you can see all the REST APIs that have generated for this asset. At present get and put are fully implemented, with transactions  - so lets try and get a list of all the land titles.;</p>

<p><img src="../images/loopback-2.png" alt="LoopBack-2" /></p>

<p>Expand the get and click on <em>Try it Out</em> to try it out.</p>

<p><img src="../images/loopback-3.png" alt="LoopBack-3" /></p>

<p>You’ll see a list of land titles presented as a set of JSON</p>

<p><img src="../images/loopback-4.png" alt="LoopBack-4" /></p>

<p>Similarly it’s quite easy to issue the curl command from a terminal prompt. This can be copied from the LoopBack web page.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -X GET --header <span class="s2">"Accept: application/json"</span> <span class="s2">"http://0.0.0.0:3000/api/net.biz.digitalProperTitle"</span> | prettyjson
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   518  100   518    0     0    549      0 --:--:-- --:--:-- --:--:--   548
-
  titleId:     LID:1148
  owner:
    <span class="nv">$class</span>:    net.biz.digitalPropertyNetwork.Person
    personId:  PID:1234567890
    firstName: Fred
    lastName:  Bloggs
  information: A nice house <span class="k">in </span>the country
  forSale:     <span class="nb">true</span>
  <span class="nv">$class</span>:      net.biz.digitalPropertyNetwork.LandTitle
-
  titleId:     LID:6789
  owner:
    <span class="nv">$class</span>:    net.biz.digitalPropertyNetwork.Person
    personId:  PID:1234567890
    firstName: Fred
    lastName:  Bloggs
  information: A small flat <span class="k">in </span>the city
  forSale:     <span class="nb">true</span>
  <span class="nv">$class</span>:      net.biz.digitalPropertyNetwork.LandTitle
</code></pre>
</div>
<p>## Submitting a transaction via REST</p>

<p>If you go back to the main page and search down to the register property for sale, we can mark the other property for sale.
In this example, we’ve specified the other landtitle in the data box, we’ve also had to specify the transaction id and the timestamp (the last two will change shortly).</p>

<p><img src="../images/loopback-5.png" alt="LoopBack-5" /></p>

<p>Click on the <em>Try it out!</em> button to submit the transaction. You’ll see a succesful return code, but if you now return to your terminal prompt in the Getting Started directory, you can run the list assets command again.</p>

<p>You’ll see now that the other land title has been marked for sale.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>npm run listAssets

<span class="gp">&gt; </span>concerto-gettingstarted@1.0.0 listAssets /home/matthew/git17/Concerto-GettingStarted
<span class="gp">&gt; </span>node cli.js landregistry list

info: <span class="o">[</span>Handel] IBM Concerto: Handel appliation
info: <span class="o">[</span>Handel] LandRegistry:&lt;init&gt; businessNetworkDefinition obtained digitalproperty-network@0.0.22-20170116133558
info: <span class="o">[</span>Handel] listTitles Getting the asset registry
info: <span class="o">[</span>Handel] listTitles Getting all assest from the registry.
info: <span class="o">[</span>Handel] listTitles Current Land Titles
info: <span class="o">[</span>Handel] Titles listed
info: <span class="o">[</span>Handel]
┌──────────┬────────────────┬────────────┬─────────┬─────────────────────────────┬─────────┐
│ TitleID  │ OwnerID        │ First Name │ Surname │ Description                 │ ForSale │
├──────────┼────────────────┼────────────┼─────────┼─────────────────────────────┼─────────┤
│ LID:1148 │ PID:1234567890 │ Fred       │ Bloggs  │ A nice house <span class="k">in </span>the country │ Yes     │
├──────────┼────────────────┼────────────┼─────────┼─────────────────────────────┼─────────┤
│ LID:6789 │ PID:1234567890 │ Fred       │ Bloggs  │ A small flat <span class="k">in </span>the city    │ Yes     │
└──────────┴────────────────┴────────────┴─────────┴─────────────────────────────┴─────────┘
info: <span class="o">[</span>Handel] Command completed successfully.

</code></pre>
</div>

<p>#Summary
Using the Loopback framework on top of the Fabric Composer runtime has allowed us to generate a business domain specific REST api based on the deployed business network model!</p>
