<p>#Getting Started with a Fabric Composer node.js application</p>

<p>We’ll walk through the sample node.js applications here. The git repo is the GettingStarted repo that was cloned for the Getting Started.
The <a href="https://github.com/fabric-composer/sample-applications/blob/master/packages/getting-started/lib/landRegistry.js"><code class="highlighter-rouge">landregistry.js</code></a> file contains a class to the represent the land regsitry and contains methods for listing the land titles, adding default titles, and submitting the transaction.
This has been implemented using a javascript class; however you are free to structure your code as you wish. The framework’s API is agnostic to this.
The application is also setup as a command line driven application using yargs (see the files in the cmd directory).</p>

<p>We’ll look at section of functionality in turn after first looking at the modules that are required and how to connect to a Fabric Composer hosted application on the Hyperledger Fabric.</p>

<h2 id="promises">Promises</h2>
<p>It’s worth highlighting that the style of the API is to use promises. Typically Fabric Composer APIs will return a promise that is resolved when the operation has been successfully completed or with the result of the operation if applicable.</p>

<p>If you’re not familiar with Promise based development it’s worth reviewing some of the tutorials online to get an idea. For example [https://scotch.io/tutorials/understanding-javascript-promises-pt-i-background-basics]</p>

<h2 id="modules-required">Modules required</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">BusinessNetworkConnection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'composer-client'</span><span class="p">).</span><span class="nx">BusinessNetworkConnection</span><span class="p">;</span>
</code></pre>
</div>
<p>For a client application this is only Fabric Composer require needed. In this getting started application we also use the <code class="highlighter-rouge">cli-table</code> and <code class="highlighter-rouge">winston</code> and <code class="highlighter-rouge">config</code> modules for support processing. We use these to get information from the command line options, formatting of output and logging.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">winston</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'winston'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'config'</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">'gettingstarted'</span><span class="p">);</span>

<span class="c1">// these are the credentials to use to connect to the Hyperledger Fabric</span>
<span class="kd">let</span> <span class="nx">participantId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'participantId'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">participantPwd</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'participantPwd'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">LOG</span> <span class="o">=</span> <span class="nx">winston</span><span class="p">.</span><span class="nx">loggers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'application'</span><span class="p">);</span>
</code></pre>
</div>

<h2 id="connecting-to-the-fabric-composer-runtime">Connecting to the Fabric Composer Runtime</h2>
<p>We’ve split the code to connect into two parts, part in the constructor of the object and part in an initialization method. This is an implementation decision made for this example - you are free to structure this in the way that best suits your application. What’s important is the API calls and the data.</p>

<p>The key thing here is that we need to create a new BusinessNetworkConnection object; and get from application configuration, the connection profile and the business network identifier needed.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BusinessNetworkConnection</span><span class="p">();</span>
<span class="k">this</span><span class="p">.</span><span class="nx">CONNECTION_PROFILE_NAME</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'connectionProfile'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">businessNetworkIdentifier</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'businessNetworkIdentifier'</span><span class="p">);</span>
</code></pre>
</div>

<p>The first Fabric Composer API call that we are going to make here, is the connect() API, to establish the connection to the Fabric Composer runtime on the Hyperledger Fabric.
This API returns the businessNetworkDefinition if successful - which we hold onto.  The API takes, the connection profile name, business network identifier and participant details.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">CONNECTION_PROFILE_NAME</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">businessNetworkIdentifier</span><span class="p">,</span> <span class="nx">participantId</span><span class="p">,</span> <span class="nx">participantPwd</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">businessNetworkDefinition</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">});</span>
</code></pre>
</div>

<p>For a client application this is all the essential setup that is required, from this point on it’s up to what the application wants to do as to what APIs are called.</p>

<p>##Adding assets to a regsitry
The Fabric Composer runtime will create a default registry to store assets in. So in this example, a LandTitle registry will have been created. What we want to do here is get access to that registry and then add some assets. This <code class="highlighter-rouge">getAssetRegistry()</code> takes the fully qualified asset name as defined in the CTO model file (That’s namespace plus asset name). It returns a promise that is resolved with the asset registry, which we hold onto.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span><span class="p">.</span><span class="nx">getAssetRegistry</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork.LandTitle'</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">titlesRegistry</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Next step is to create some assets (look for the method <code class="highlighter-rouge">_bootstrapTitles</code> in the code )</p>

<p>We use a factory style pattern to be able to create assets. A factory is obtained from the businessNetworkDefinition we got early. From this we can create an instance of a ‘person’.  Note the use of the namespace and asset name.  Then we can set the properties of this asset. The indentifiers here (firstName lastName) matches with the identifiers in the model.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">factory</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">businessNetworkDefinition</span><span class="p">.</span><span class="nx">getFactory</span><span class="p">();</span>
<span class="nx">owner</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">newInstance</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork'</span><span class="p">,</span> <span class="s1">'Person'</span><span class="p">,</span> <span class="s1">'PID:1234567890'</span><span class="p">);</span>
<span class="nx">owner</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="s1">'Fred'</span><span class="p">;</span>
<span class="nx">owner</span><span class="p">.</span><span class="nx">lastName</span> <span class="o">=</span> <span class="s1">'Bloggs'</span><span class="p">;</span>
</code></pre>
</div>

<p>We now have a Person! Now we need a land title. Note how the owner is specified as being the person we just created. (In the actual sample code we do this code twice to create landTitle1 and landTitle2).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">landTitle2</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">newInstance</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork'</span><span class="p">,</span> <span class="s1">'LandTitle'</span><span class="p">,</span> <span class="s1">'LID:6789'</span><span class="p">);</span>
<span class="nx">landTitle2</span><span class="p">.</span><span class="nx">owner</span> <span class="o">=</span> <span class="nx">owner</span><span class="p">;</span>
<span class="nx">landTitle2</span><span class="p">.</span><span class="nx">information</span> <span class="o">=</span> <span class="s1">'A small flat in the city'</span><span class="p">;</span>
</code></pre>
</div>

<p>We now have a land title created that needs to be stored in the registry.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">titlesRegistry</span><span class="p">.</span><span class="nx">addAll</span><span class="p">([</span><span class="nx">landTitle1</span><span class="p">,</span> <span class="nx">landTitle2</span><span class="p">]);</span>
</code></pre>
</div>
<p>This is using an API to add multiple titles, which returns a promise that is resolved when the assets are added. The last thing we need to do is add the Person, Fred Bloggs. As this is a ‘participant’, it’s added using a different. It is very similar to assets, but this time the getParticipantRegistry API is used.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    <span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span><span class="p">.</span><span class="nx">getParticipantRegistry</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork.Person'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">personRegistry</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">personRegistry</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">owner</span><span class="p">);</span>
      <span class="p">})</span>
</code></pre>
</div>

<p>##Listing assets in a regsitry
In the sample application this is handled in a different method <code class="highlighter-rouge">list()</code>.  The same setup as for putting assets is required, so as before we need to get the asset registry but this tile we call the getAll() API. This returns an array of objects.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span><span class="p">.</span><span class="nx">getAssetRegistry</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork.LandTitle'</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">registry</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">getAll</span><span class="p">();</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">aResources</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// instantiate</span>
  <span class="kd">let</span> <span class="nx">table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Table</span><span class="p">({</span>
    <span class="na">head</span><span class="p">:</span> <span class="p">[</span><span class="s1">'TitleID'</span><span class="p">,</span> <span class="s1">'OwnerID'</span><span class="p">,</span> <span class="s1">'First Name'</span><span class="p">,</span> <span class="s1">'Surname'</span><span class="p">,</span> <span class="s1">'Description'</span><span class="p">,</span> <span class="s1">'ForSale'</span><span class="p">]</span>
  <span class="p">});</span>
  <span class="kd">let</span> <span class="nx">arrayLength</span> <span class="o">=</span> <span class="nx">aResources</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arrayLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">tableLine</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">tableLine</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">titleId</span><span class="p">);</span>
    <span class="nx">tableLine</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">owner</span><span class="p">.</span><span class="nx">personId</span><span class="p">);</span>
    <span class="nx">tableLine</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">owner</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span>
    <span class="nx">tableLine</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">owner</span><span class="p">.</span><span class="nx">lastName</span><span class="p">);</span>
    <span class="nx">tableLine</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">information</span><span class="p">);</span>
    <span class="nx">tableLine</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aResources</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">forSale</span> <span class="p">?</span> <span class="s1">'Yes'</span> <span class="p">:</span> <span class="s1">'No'</span><span class="p">);</span>
    <span class="nx">table</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tableLine</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Put to stdout - as this is really a command line app</span>
  <span class="k">return</span><span class="p">(</span><span class="nx">table</span><span class="p">);</span>
<span class="p">})</span>
</code></pre>
</div>
<p>Most of this isn’t Fabric Composer API code - but it shows how to access the details of the objects that have been returned. At this point it’s worth just looking again at the model.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>asset LandTitle identified by titleId {
  o String   titleId
  o Person   owner
  o String   information
  o Boolean  forSale   optional
}

participant Person identified by personId {
  o String personId
  o String firstName
  o String lastName
}
</code></pre>
</div>
<p>You can see how the owner and title information are being accessed in a very simple manner</p>

<h2 id="submitting-a-transactions">Submitting a transactions</h2>
<p>The last thing that we need to do is submit a transaction. This is the definition of the transaction in the model file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>transaction RegisterPropertyForSale identified by transactionId{
  o String transactionId
  --&gt; LandTitle title
}
</code></pre>
</div>

<p>The transaction has two fields here, a trandsactionId, and a reference to the land title that should be submitted for sale. The first step is get access to the registry for the landtitle, and get back the specific land title we want to submit for sale.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span><span class="p">.</span><span class="nx">getAssetRegistry</span><span class="p">(</span><span class="s1">'net.biz.digitalPropertyNetwork.LandTitle'</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">registry</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'LID:1148'</span><span class="p">);</span>
<span class="p">})</span>
</code></pre>
</div>
<p>The getAssetRegistry call should now be looking a bit familar, the get API is used to get a specific land title.
The next step is to create the transaction we want to submit.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">serializer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">businessNetworkDefinition</span><span class="p">.</span><span class="nx">getSerializer</span><span class="p">();</span>

<span class="kd">let</span> <span class="nx">resource</span> <span class="o">=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">({</span>
  <span class="s1">'$class'</span><span class="p">:</span> <span class="s1">'net.biz.digitalPropertyNetwork.RegisterPropertyForSale'</span><span class="p">,</span>
  <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'LID:1148'</span>
<span class="p">});</span>

<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bizNetworkConnection</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">resource</span><span class="p">);</span>

</code></pre>
</div>
<p>What we need to do here is create a ‘serializer’.  This is able to create a resource - this resource is then passed to the submitTransaction API.
Note that the transaction JSON matches the structure specified in the model file.</p>

<p>That’s it!</p>
